#include <ESP8266WiFi.h>
#include <EEPROM.h>

// ====== USER SETTINGS ======
const char* ssid    = "Admin";          
const char* apiKey  = "JF10UCRBNQIBX0GE"; 
const float VOLTAGE = 230.0;           
const uint16_t UPLOAD_INTERVAL_S = 16;  


const char* server = "api.thingspeak.com";
WiFiClient client;

// Energy persistence (EEPROM)
float energy_kWh = 0.0f;                
const int EEPROM_SIZE = 64;
const int EEPROM_ADDR = 0;              
uint16_t persist_counter = 0;         

// parsing buffer
String inputData = "";

void saveEnergyToEEPROM() {
  EEPROM.put(EEPROM_ADDR, energy_kWh);
  EEPROM.commit();
}

void loadEnergyFromEEPROM() {
  EEPROM.begin(EEPROM_SIZE);
  EEPROM.get(EEPROM_ADDR, energy_kWh);
  if (!isfinite(energy_kWh) || energy_kWh < 0) energy_kWh = 0.0f;
}

void setup() {
  Serial.begin(9600);
  delay(800);
  Serial.println("\nBooting NodeMCU with Power/Energy upload...");

  loadEnergyFromEEPROM();
  Serial.print("Restored energy (kWh): ");
  Serial.println(energy_kWh, 6);

  // Open network (no password)
  WiFi.begin(ssid);
  Serial.print("Connecting to Wi-Fi");
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }
  Serial.println("\n‚úÖ WiFi Connected!");
  Serial.print("IP Address: ");
  Serial.println(WiFi.localIP());
  Serial.println("Waiting for Arduino data...");
}

void loop() {
  if (!Serial.available()) return;

  inputData = Serial.readStringUntil('\n');
  inputData.trim();
  if (inputData.length() == 0) return;

  // Expected CSV: temp,hum,motion,current
  float t = 0, h = 0, current_A = 0;
  int motion = 0;
  sscanf(inputData.c_str(), "%f,%f,%d,%f", &t, &h, &motion, &current_A);

  // Compute power (W) and accumulate energy (kWh)
  float absCurrent = fabs(current_A);                  
  float power_W    = absCurrent * VOLTAGE;            
  float dt_h       = UPLOAD_INTERVAL_S / 3600.0f;     
  energy_kWh      += (power_W * dt_h) / 1000.0f;      

  Serial.print("RX: "); Serial.println(inputData);
  Serial.print("Power (W): "); Serial.print(power_W, 3);
  Serial.print(" | Energy (kWh): "); Serial.println(energy_kWh, 6);

  // Persist energy occasionally 
  if (++persist_counter >= 30) {
    saveEnergyToEEPROM();
    persist_counter = 0;
    Serial.println("üíæ Energy saved to EEPROM.");
  }

  // ---- Upload to ThingSpeak ----
  if (client.connect(server, 80)) {
    String url = "/update?api_key=" + String(apiKey) +
                 "&field1=" + String(t) +
                 "&field2=" + String(h) +
                 "&field3=" + String(motion) +
                 "&field4=" + String(current_A, 4) +
                 "&field5=" + String(power_W, 2) +
                 "&field6=" + String(energy_kWh, 6);

    Serial.println("üåê Sending to ThingSpeak...");
    Serial.println(url);

    client.print(String("GET ") + url + " HTTP/1.1\r\n" +
                 "Host: " + server + "\r\n" +
                 "Connection: close\r\n\r\n");
    client.stop();
    Serial.println("‚úÖ Data sent to ThingSpeak!");
  } else {
    Serial.println("‚ùå Failed to connect to ThingSpeak!");
  }

  delay(UPLOAD_INTERVAL_S * 1000UL);
}
